<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å¥¢è¯çœŸå¿ƒè©±å¤§å†’éšª v3.0 Ultimate</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>
    <script src="questions_easy.js"></script>
    <script src="questions_normal.js"></script>
    <script src="questions_hard.js"></script>
    <script src="questions_adult.js"></script>
    <link href="style.css" rel="stylesheet" />
  </head>
  <body>
    <div id="flash-overlay"></div>
    <div id="login-overlay">
      <div class="login-box">
        <div class="login-title">
          å¥¢è¯çœŸå¿ƒè©±å¤§å†’éšª<br /><span
            style="font-size: 1rem; font-weight: normal; color: #888"
            >Online Edition v3.0</span
          >
        </div>
        <input
          type="text"
          id="nickname-input"
          placeholder="è«‹è¼¸å…¥ä½ çš„æš±ç¨±"
          style="
            margin-bottom: 20px;
            width: 100%;
            text-align: center;
            font-size: 1.1rem;
          "
        />
        <button class="mode-btn primary" onclick="NetworkModule.createRoom()">
          å‰µå»ºæˆ¿é–“ (Host)
        </button>
        <div class="join-group">
          <input
            type="text"
            id="room-code-input"
            placeholder="è¼¸å…¥6ä½æ•¸æˆ¿é–“ç¢¼"
            style="
              background: #333;
              color: #fff;
              border-color: #666;
              text-transform: uppercase;
            "
          />
          <button
            class="mode-btn"
            class="mode-btn btn-scan"
            onclick="ScannerModule.start()"
          >
            <i class="material-icons">qr_code_scanner</i>
          </button>
          <button class="mode-btn btn-join" onclick="NetworkModule.joinRoom()">
            åŠ å…¥
          </button>
        </div>
        <button class="mode-btn" onclick="NetworkModule.startOffline()">
          å–®æ©Ÿæ¨¡å¼
        </button>
      </div>
    </div>

    <!-- Scanner Overlay -->
    <div id="scanner-overlay" class="modal-overlay hidden">
      <div class="modal-box">
        <div style="color: var(--gold); margin-bottom: 10px; font-weight: bold">
          æƒææˆ¿é–“ç¢¼
        </div>
        <div id="reader"></div>
        <button class="btn-small btn-danger" onclick="ScannerModule.stop()">
          é—œé–‰
        </button>
      </div>
    </div>

    <!-- QR Display Overlay -->
    <div id="qr-display-overlay" class="modal-overlay hidden">
      <div class="modal-box">
        <div style="color: var(--gold); margin-bottom: 10px; font-weight: bold">
          æˆ¿é–“ QR Code
        </div>
        <img id="qr-image" src="" alt="Room QR" />
        <button
          class="btn-small btn-danger"
          onclick="document.getElementById('qr-display-overlay').classList.add('hidden')"
        >
          é—œé–‰
        </button>
      </div>
    </div>

    <!-- Personal History Overlay -->
    <div id="personal-history-overlay" class="modal-overlay hidden">
      <div
        class="modal-box"
        style="max-height: 80vh; display: flex; flex-direction: column"
      >
        <div
          style="
            color: var(--gold);
            margin-bottom: 10px;
            font-weight: bold;
            flex-shrink: 0;
          "
        >
          æˆ‘çš„å·²æŠ½é¡Œç›® (é˜²é‡è¤‡è¨˜éŒ„)
        </div>
        <div
          id="personal-history-list"
          class="list-container"
          style="overflow-y: auto; flex: 1; text-align: left"
        ></div>
        <div style="margin-top: 10px; flex-shrink: 0">
          <button
            class="btn-small btn-danger"
            onclick="document.getElementById('personal-history-overlay').classList.add('hidden')"
          >
            é—œé–‰
          </button>
        </div>
      </div>
    </div>

    <div id="danmaku-layer"></div>
    <audio id="bgm" loop><source src="bgm.mp3" type="audio/mpeg" /></audio>
    <audio id="sfx-spin"><source src="spin.mp3" type="audio/mpeg" /></audio>
    <audio id="sfx-win"><source src="win.mp3" type="audio/mpeg" /></audio>
    <audio id="sfx-alarm"><source src="alarm.mp3" type="audio/mpeg" /></audio>

    <header>
      <button id="menu-toggle"><i class="material-icons">menu</i></button>
      <div class="status-bar">
        <div id="status-indicator" class="status-dot"></div>
        <span id="room-display" class="room-code">OFFLINE</span>
        <button id="qr-btn" onclick="UIModule.showRoomQR()">
          <i class="material-icons">qr_code</i>
        </button>
      </div>
      <h1>çœŸå¿ƒè©±å¤§å†’éšª</h1>
    </header>

    <main>
      <section id="panel-home" class="panel active">
        <div class="wheel-container">
          <div class="pointer"></div>
          <div class="center-circle"></div>
          <canvas id="wheelCanvas" width="300" height="300"></canvas>
        </div>
        <div class="game-info">
          <div class="current-player" id="display-player">
            <i class="material-icons">person</i>
            <span id="player-name-slot">æº–å‚™é–‹å§‹</span>
          </div>
          <div class="result-box" id="display-result">é»æ“ŠæŒ‰éˆ•æˆ–ç©ºç™½éµæ—‹è½‰</div>
        </div>
        <button id="spinBtn" class="btn-main" disabled>é–‹å§‹æŠ½ç±¤</button>
        <div
          id="guest-msg"
          class="guest-hidden"
          style="text-align: center; color: #888; margin-top: 10px"
        >
          ç­‰å¾…æˆ¿ä¸»æ“ä½œ...
        </div>
      </section>

      <section id="panel-players" class="panel">
        <div class="section-title">
          <span>ç©å®¶åå–® (<span id="player-count">0</span>)</span>
          <button
            id="reset-weights-btn"
            class="btn-small btn-outline host-only"
            style="font-size: 0.8rem"
          >
            <i
              class="material-icons"
              style="font-size: 1rem; vertical-align: middle"
              >refresh</i
            >
            é‡ç½®æ¬Šé‡
          </button>
        </div>
        <div class="input-group host-only">
          <input
            type="text"
            id="new-player-input"
            placeholder="è¼¸å…¥ç©å®¶åç¨±..."
          />
          <button id="add-player-btn" class="btn-small">
            <i class="material-icons">add</i>
          </button>
        </div>
        <div
          class="input-group host-only"
          style="align-items: center; margin-bottom: 10px; margin-top: -10px"
        >
          <input
            type="checkbox"
            id="check-auto-reduce"
            style="flex: 0; width: 20px; height: 20px; margin-right: 10px"
          />
          <label
            for="check-auto-reduce"
            style="color: #aaa; font-size: 0.9rem; cursor: pointer"
          >
            é¸ä¸­å¾Œè‡ªå‹•é™ä½æ¬Šé‡ (é¿å…é€£çºŒ)
          </label>
        </div>
        <div id="player-list" class="list-container"></div>
      </section>

      <section id="panel-leaderboard" class="panel">
        <div class="section-title">
          <span>è¢«é¸ä¸­æ¬¡æ•¸æ’è¡Œ</span>
          <button id="reset-stats-btn" class="btn-small btn-danger host-only">
            é‡ç½®
          </button>
        </div>
        <div id="leaderboard-list" class="list-container"></div>
      </section>

      <section id="panel-timer" class="panel">
        <div class="section-title"><span>è¨ˆæ™‚å™¨</span></div>
        <div class="difficulty-tabs" id="timer-mode-selector">
          <div class="diff-tab active" data-mode="countdown">å€’æ•¸è¨ˆæ™‚</div>
          <div class="diff-tab" data-mode="stopwatch">è¨ˆæ™‚ç¢¼éŒ¶</div>
        </div>
        <div class="timer-display-box">
          <div id="timer-display" class="timer-time">00:00</div>
        </div>
        <div
          class="timer-presets"
          id="timer-presets-container"
          style="display: flex"
        >
          <button
            class="btn-small btn-outline"
            onclick="TimerModule.addTime(10)"
          >
            +10s
          </button>
          <button
            class="btn-small btn-outline"
            onclick="TimerModule.addTime(30)"
          >
            +30s
          </button>
          <button
            class="btn-small btn-outline"
            onclick="TimerModule.addTime(60)"
          >
            +1m
          </button>
          <button
            class="btn-small btn-outline"
            onclick="TimerModule.addTime(300)"
          >
            +5m
          </button>
        </div>
        <div class="timer-controls">
          <button
            class="timer-btn-circle"
            id="timer-btn-reset"
            title="é‡ç½®"
            onclick="TimerModule.reset()"
          >
            <i class="material-icons">replay</i>
          </button>
          <button
            class="timer-btn-circle"
            id="timer-btn-start"
            title="é–‹å§‹/æš«åœ"
            style="background: var(--gold); color: #000"
            onclick="TimerModule.toggle()"
          >
            <i class="material-icons" id="timer-icon-play">play_arrow</i>
          </button>
        </div>
      </section>

      <section id="panel-questions" class="panel">
        <div class="section-title">
          <span>å•é¡Œåº«</span>
          <div class="host-only">
            <button
              id="clear-q-btn"
              class="btn-small btn-danger"
              style="margin-right: 5px"
            >
              <i class="material-icons">delete_sweep</i> æ¸…ç©º
            </button>
            <button
              id="reset-used-btn"
              class="btn-small btn-outline"
              style="margin-right: 5px"
            >
              <i class="material-icons">replay</i> é‡ç½®å·²ç”¨
            </button>
            <button id="ai-generate-btn" class="btn-small btn-ai">
              <i class="material-icons">auto_awesome</i> AI ç”¢ç”Ÿ
            </button>
          </div>
        </div>
        <div class="difficulty-tabs" id="diff-selector">
          <div class="diff-tab active" data-val="all">å…¨éƒ¨</div>
          <div class="diff-tab" data-val="truth">çœŸå¿ƒè©±</div>
          <div class="diff-tab" data-val="dare">å¤§å†’éšª</div>
        </div>
        <div class="input-group">
          <select id="q-type" style="flex: 0.4">
            <option value="truth">çœŸå¿ƒè©±</option>
            <option value="dare">å¤§å†’éšª</option>
          </select>
          <input type="text" id="new-q-input" placeholder="è¼¸å…¥å•é¡Œ..." />
          <button id="add-q-btn" class="btn-small">
            <i class="material-icons">add</i>
          </button>
        </div>
        <div
          class="input-group input-group--options"
          style="
            margin-top: 15px;
            border-top: 1px solid var(--gold-dark);
            padding-top: 10px;
          "
        >
          <label
            ><i
              class="material-icons"
              style="font-size: 1rem; vertical-align: middle"
              >filter_list</i
            >
            ç¯©é¸ç­‰ç´š:</label
          >
          <select id="list-difficulty-filter">
            <option value="all">å…¨éƒ¨é¡¯ç¤º</option>
            <option value="Easy">ç°¡å–®</option>
            <option value="Normal">æ™®é€š</option>
            <option value="Hard">å›°é›£</option>
            <option value="Adult">å¤§äººå°ˆå±¬</option>
          </select>
        </div>
        <div id="question-list" class="list-container"></div>
      </section>

      <section id="panel-history" class="panel">
        <div class="section-title">
          <span>æ­·å²è¨˜éŒ„</span>
          <div>
            <button
              id="btn-my-history"
              class="btn-small btn-outline"
              style="margin-right: 5px"
            >
              <i
                class="material-icons"
                style="font-size: 1rem; vertical-align: middle"
                >assignment_ind</i
              >
              æˆ‘çš„å·²æŠ½
            </button>
            <button
              id="clear-history-btn"
              class="btn-small btn-danger host-only"
            >
              æ¸…é™¤
            </button>
          </div>
        </div>
        <div id="history-list" class="list-container"></div>
      </section>

      <section id="panel-settings" class="panel">
        <div class="section-title">è½‰ç›¤é…ç½® (Host Only)</div>
        <div class="slider-container">
          <label>çœŸå¿ƒè©±æ ¼æ•¸</label>
          <div class="range-wrapper">
            <input
              type="range"
              id="range-truth"
              min="0"
              max="50"
              value="10"
              class="host-control"
            />
            <output id="val-truth" class="range-bubble">10</output>
          </div>
        </div>
        <div class="slider-container">
          <label>å¤§å†’éšªæ ¼æ•¸</label>
          <div class="range-wrapper">
            <input
              type="range"
              id="range-dare"
              min="0"
              max="50"
              value="10"
              class="host-control"
            />
            <output id="val-dare" class="range-bubble">10</output>
          </div>
        </div>
        <div class="slider-container">
          <label>Pass æ ¼æ•¸</label>
          <div class="range-wrapper">
            <input
              type="range"
              id="range-pass"
              min="0"
              max="50"
              value="2"
              class="host-control"
            />
            <output id="val-pass" class="range-bubble">2</output>
          </div>
        </div>

        <div class="section-title" style="margin-top: 30px">éŠæˆ²ç‰©ç†</div>
        <div class="slider-container">
          <label>æ—‹è½‰é€Ÿåº¦</label>
          <input
            type="range"
            id="speed-range"
            min="10"
            max="50"
            value="30"
            class="host-control"
          />
        </div>
        <div class="slider-container">
          <label>æ—‹è½‰æ™‚é–“ (ç§’)</label>
          <input
            type="range"
            id="duration-range"
            min="2"
            max="10"
            value="5"
            class="host-control"
          />
        </div>
        <div class="slider-container">
          <label>é›£åº¦ç¯©é¸</label>
          <select id="game-difficulty-filter" class="host-control">
            <option value="All">å…¨éƒ¨ (åŒ…å«æ‰€æœ‰)</option>
            <option value="Safe">é—”å®¶å’¸å®œ (ç°¡å–®+æ™®é€š)</option>
            <option value="Standard">æ¨™æº–æ¨¡å¼ (ä¸å«å¤§äºº)</option>
            <option value="Spicy">åˆºæ¿€æ¨¡å¼ (å›°é›£+å¤§äºº)</option>
            <option value="Adult">åƒ…é™å¤§äºº (18+)</option>
          </select>
        </div>
        <div
          class="slider-container"
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <label style="margin: 0">ç©å®¶é˜²é‡è¤‡ (No Repeat Players)</label>
          <input
            type="checkbox"
            id="check-no-repeat"
            class="host-control"
            style="width: 20px; height: 20px; margin: 0"
          />
        </div>
        <div
          class="slider-container"
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <label style="margin: 0">é¡Œç›®é˜²é‡è¤‡ (No Repeat Questions)</label>
          <input
            type="checkbox"
            id="check-no-repeat-q"
            class="host-control"
            style="width: 20px; height: 20px; margin: 0"
          />
        </div>
        <div
          class="slider-container"
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
          "
        >
          <label style="margin: 0">å€‹äººé¡Œç›®é˜²é‡è¤‡ (No Repeat Personal)</label>
          <input
            type="checkbox"
            id="check-no-repeat-personal"
            class="host-control"
            style="width: 20px; height: 20px; margin: 0"
          />
        </div>

        <div class="section-title host-only" style="margin-top: 30px">
          è³‡æ–™å‚™ä»½
        </div>
        <div
          class="input-group host-only"
          style="justify-content: space-between"
        >
          <button
            id="btn-export"
            class="btn-small"
            style="flex: 1; margin-right: 5px"
          >
            <i class="material-icons">download</i> åŒ¯å‡ºå‚™ä»½
          </button>
          <button
            id="btn-import"
            class="btn-small btn-outline"
            style="flex: 1; margin-left: 5px"
          >
            <i class="material-icons">upload</i> åŒ¯å…¥å‚™ä»½
          </button>
          <input
            type="file"
            id="file-import"
            style="display: none"
            accept=".json"
          />
        </div>
        <button
          id="btn-reset-default"
          class="btn-small btn-danger host-only"
          style="width: 100%; margin-top: 10px"
        >
          <i class="material-icons">restart_alt</i> æ¢å¾©é è¨­å€¼
        </button>
        <button
          id="btn-leave-room"
          class="btn-small"
          style="
            width: 100%;
            margin-top: 10px;
            background: #444;
            border: 1px solid #666;
          "
        >
          <i class="material-icons">logout</i> é€€å‡ºæˆ¿é–“ / è¿”å›é¦–é 
        </button>
      </section>
    </main>

    <!-- Floating Reaction Menu -->
    <div class="reaction-wrapper">
      <button class="reaction-toggle" onclick="UIModule.toggleReactions()">
        <i class="material-icons">sentiment_satisfied_alt</i>
      </button>
      <div id="reaction-menu" class="reaction-menu hidden">
        <button class="reaction-btn" onclick="NetworkModule.sendReaction('ğŸ‘')">
          ğŸ‘
        </button>
        <button class="reaction-btn" onclick="NetworkModule.sendReaction('ğŸ˜‚')">
          ğŸ˜‚
        </button>
        <button class="reaction-btn" onclick="NetworkModule.sendReaction('ğŸ»')">
          ğŸ»
        </button>
        <button class="reaction-btn" onclick="NetworkModule.sendReaction('ğŸ˜®')">
          ğŸ˜®
        </button>
        <button class="reaction-btn" onclick="NetworkModule.sendReaction('â¤ï¸')">
          â¤ï¸
        </button>
      </div>
    </div>

    <nav>
      <button
        class="nav-btn active"
        onclick="UIModule.switchPanel('panel-home', this)"
      >
        <i class="material-icons">casino</i><span>éŠæˆ²</span>
      </button>
      <button
        class="nav-btn"
        onclick="UIModule.switchPanel('panel-players', this)"
      >
        <i class="material-icons">group</i><span>ç©å®¶</span>
      </button>
      <button
        class="nav-btn"
        onclick="UIModule.switchPanel('panel-leaderboard', this)"
      >
        <i class="material-icons">emoji_events</i><span>æ’è¡Œ</span>
      </button>
      <button
        class="nav-btn"
        onclick="UIModule.switchPanel('panel-timer', this)"
      >
        <i class="material-icons">timer</i><span>è¨ˆæ™‚</span>
      </button>
      <button
        class="nav-btn"
        onclick="UIModule.switchPanel('panel-questions', this)"
      >
        <i class="material-icons">edit_note</i><span>é¡Œåº«</span>
      </button>
      <button
        class="nav-btn"
        onclick="UIModule.switchPanel('panel-history', this)"
      >
        <i class="material-icons">history</i><span>è¨˜éŒ„</span>
      </button>
      <button
        class="nav-btn"
        onclick="UIModule.switchPanel('panel-settings', this)"
      >
        <i class="material-icons">settings</i><span>è¨­å®š</span>
      </button>
    </nav>

    <script>
      /* ==================== Firebase Config ==================== */
      const firebaseConfig = {
        apiKey: "AIzaSyBi-VIoa3swbrQqoeik9y5FtOHheJ3x8KA",
        authDomain: "truth-or-dare-online-v2.firebaseapp.com",
        databaseURL:
          "https://truth-or-dare-online-v2-default-rtdb.firebaseio.com",
        projectId: "truth-or-dare-online-v2",
        storageBucket: "truth-or-dare-online-v2.firebasestorage.app",
        messagingSenderId: "144397063274",
        appId: "1:144397063274:web:5c9e0d2161a1fcdd296613",
        measurementId: "G-86LC0DZ2RS",
      };

      let db = null;
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
      } catch (e) {
        console.warn("Firebase Init Error:", e);
      }

      /* ==================== Network Module ==================== */
      const NetworkModule = {
        roomId: null,
        isHost: false,
        nickname: "åŒ¿å",
        roomRef: null,
        lastProcessedSpinTrigger: 0,
        lastProcessedResultTime: 0,
        pendingResult: null,
        nextSpinner: null,

        createRoom() {
          if (!db) return this.startOffline();
          const name =
            document.getElementById("nickname-input").value.trim() || "Host";
          this.nickname = name;
          this.isHost = true;
          this.roomId = Math.floor(100000 + Math.random() * 900000).toString();

          this.roomRef = db.ref("rooms/" + this.roomId);

          // ä½¿ç”¨ç‰©ä»¶çµæ§‹å„²å­˜ç©å®¶ï¼Œä»¥ä¾¿è™•ç† onDisconnect
          // åˆå§‹åŒ–æˆ¿é–“ï¼Œå°‡ LocalStorage çš„è³‡æ–™æ¨ä¸Šå»
          const initialData = {
            host: name,
            status: "waiting",
            spinTrigger: 0,
            currentResult: null,
            createdAt: firebase.database.ServerValue.TIMESTAMP,
            players: {}, // åˆå§‹åŒ–ç‚ºç©ºç‰©ä»¶ï¼ŒenterGame æœƒåŠ å…¥æˆ¿ä¸»
            questions: DataModule.state.questions, // Sync questions
            settings: DataModule.state.settings, // Sync settings
            history: [],
            usedQuestions: [],
            playerQuestionHistory: {},
            stats: {},
            nextSpinner: null,
          };

          this.roomRef.set(initialData).then(() => {
            this.enterGame();
          });
        },

        joinRoom() {
          if (!db) return this.startOffline();
          const code = document.getElementById("room-code-input").value.trim();
          const name =
            document.getElementById("nickname-input").value.trim() || "Guest";
          if (code.length !== 6) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„6ä½æ•¸æˆ¿é–“ç¢¼");

          this.roomId = code;
          this.nickname = name;
          this.isHost = false;
          this.roomRef = db.ref("rooms/" + this.roomId);

          this.roomRef.once("value").then((snapshot) => {
            if (snapshot.exists()) {
              this.enterGame();
            } else {
              alert("æˆ¿é–“ä¸å­˜åœ¨ï¼");
            }
          });
        },

        startOffline() {
          this.isHost = true;
          this.roomId = "LOCAL";
          this.enterGame();
        },

        enterGame() {
          document.getElementById("login-overlay").classList.add("hidden");
          const roomText = this.isHost
            ? `${this.roomId} (Host)`
            : `${this.roomId}`;
          document.getElementById("room-display").innerText =
            this.roomId === "LOCAL" ? "OFFLINE" : roomText;

          if (this.roomId !== "LOCAL") {
            document.getElementById("status-indicator").classList.add("online");
            document.getElementById("qr-btn").style.display = "inline-block";

            // è¨­å®šç©å®¶ä¸Šç·šèˆ‡æ–·ç·šè‡ªå‹•ç§»é™¤
            // æ›¿æ›ä¸åˆæ³•å­—å…ƒä»¥ä½œç‚º Key
            const safeName = this.nickname.replace(/[.$#\[\]\/]/g, "_");
            const playerRef = this.roomRef.child("players/" + safeName);
            playerRef.set({
              name: this.nickname,
              isHost: this.isHost,
              weight: 50,
            });
            playerRef.onDisconnect().remove();

            this.listenForUpdates();
            this.listenForReactions();
          } else {
            // å–®æ©Ÿæ¨¡å¼ï¼šå¾ local storage åˆå§‹åŒ–
            DataModule.loadFromStorage();
          }

          UIModule.updateRoleUI();

          // å¦‚æœæ˜¯ Hostï¼Œæ¯æ¬¡æœ¬åœ°æ•¸æ“šè®Šå‹•éƒ½ä¸Šå‚³
          // å¦‚æœæ˜¯ Guestï¼ŒaddPlayer åªæ˜¯ç‚ºäº†æ›´æ–°æœ¬åœ°é¡¯ç¤ºï¼ŒçœŸå¯¦åŒæ­¥åœ¨ listenForUpdates
          if (!this.isHost && this.roomId !== "LOCAL") {
            // Guest specific init if needed
          } else {
            // Host: sync local players to UI
            UIModule.renderPlayerList();
          }
        },

        listenForUpdates() {
          // ç›£è½æ‰€æœ‰é‡è¦è³‡æ–™
          this.roomRef.on("value", (snap) => {
            const val = snap.val();
            if (!val) return;

            // Sync Players
            // å°‡ Firebase çš„ç‰©ä»¶çµæ§‹ { key: {name: "A"}, key2: {name: "B"} } è½‰å›é™£åˆ— ["A", "B"]
            // v3.1 Update: Sync objects {name, weight}
            const serverPlayersObj = val.players || {};
            const serverPlayersList = Object.values(serverPlayersObj).map(
              (p) => ({
                name: p.name,
                weight: p.weight !== undefined ? p.weight : 50,
              })
            );

            if (
              JSON.stringify(DataModule.state.players) !==
              JSON.stringify(serverPlayersList)
            ) {
              DataModule.state.players = serverPlayersList;
              UIModule.renderPlayerList();
            }

            // Sync Questions
            const serverQuestions = val.questions || [];
            if (
              JSON.stringify(DataModule.state.questions) !==
              JSON.stringify(serverQuestions)
            ) {
              DataModule.state.questions = serverQuestions;
              DataModule.saveToStorage();
              UIModule.renderQuestionList();
            }

            // Sync Settings
            if (!this.isHost && val.settings) {
              DataModule.state.settings = val.settings;
              UIModule.renderSettingsValues();
              WheelModule.generateSegments();
              WheelModule.draw();
            }

            // Sync History
            if (val.history) {
              DataModule.state.history = val.history;
              UIModule.renderHistory();
            }

            // Sync Used Questions
            if (val.usedQuestions) {
              DataModule.state.usedQuestions = val.usedQuestions;
              UIModule.renderQuestionList();
            } else if (val && !val.usedQuestions) {
              DataModule.state.usedQuestions = [];
              UIModule.renderQuestionList();
            }

            // Sync Player Question History
            if (val.playerQuestionHistory) {
              DataModule.state.playerQuestionHistory =
                val.playerQuestionHistory;
            } else if (val && !val.playerQuestionHistory) {
              DataModule.state.playerQuestionHistory = {};
            }

            // Sync Stats
            if (val.stats) {
              DataModule.state.stats = val.stats;
              // Only re-render if active panel is leaderboard to save performance
              if (
                document
                  .getElementById("panel-leaderboard")
                  .classList.contains("active")
              ) {
                UIModule.renderLeaderboard();
              }
            }

            // Sync Spin
            if (
              val.spinTrigger &&
              val.spinTrigger > this.lastProcessedSpinTrigger
            ) {
              this.lastProcessedSpinTrigger = val.spinTrigger;
              if (
                val.spinTrigger > Date.now() - 10000 &&
                !WheelModule.isSpinning
              ) {
                WheelModule.spin(false);
              }
            }

            // Sync Result
            if (
              !this.isHost &&
              val.currentResult &&
              val.currentResult.timestamp > this.lastProcessedResultTime
            ) {
              this.lastProcessedResultTime = val.currentResult.timestamp;
              if (WheelModule.isSpinning) {
                this.pendingResult = val.currentResult;
              } else {
                UIModule.showResult(
                  val.currentResult.type,
                  val.currentResult.content,
                  val.currentResult.player,
                  val.currentResult.level,
                  val.currentResult.isReset
                );
              }
            }

            // Sync Next Spinner
            if (val.nextSpinner !== undefined) {
              this.nextSpinner = val.nextSpinner;
              UIModule.updateSpinPermission();
            }
          });
        },

        listenForReactions() {
          // Listen for new reactions
          // Use limitToLast(1) to avoid fetching huge history,
          // and check timestamp to ignore old ones on initial load.
          this.roomRef
            .child("reactions")
            .limitToLast(1)
            .on("child_added", (snap) => {
              const val = snap.val();
              if (!val) return;
              // Allow 5 seconds buffer. If older than 5s, ignore.
              if (Date.now() - val.ts < 5000) {
                UIModule.showReaction(val.emoji);
              }
            });
        },

        leaveRoom() {
          if (this.roomId !== "LOCAL" && this.roomRef) {
            // ç§»é™¤ç·šä¸Šç©å®¶ç¯€é»
            const safeName = this.nickname.replace(/[.$#\[\]\/]/g, "_");
            this.roomRef.child("players/" + safeName).remove();
            this.roomRef.off(); // åœæ­¢ç›£è½
          }

          this.roomId = null;
          this.isHost = false;
          this.roomRef = null;

          // é‡ç½® UI èˆ‡ç‹€æ…‹
          document.getElementById("login-overlay").classList.remove("hidden");
          document.getElementById("room-display").innerText = "OFFLINE";
          document
            .getElementById("status-indicator")
            .classList.remove("online");
          document.getElementById("qr-btn").style.display = "none";
        },

        sendReaction(emoji) {
          if (this.roomId !== "LOCAL" && this.roomRef) {
            this.roomRef.child("reactions").push({
              emoji: emoji,
              sender: this.nickname,
              ts: firebase.database.ServerValue.TIMESTAMP,
            });
          } else {
            // Local mode: just show it
            UIModule.showReaction(emoji);
          }
        },

        // Update Helpers
        pushUpdate(key, data) {
          if (this.roomId === "LOCAL" || !this.roomRef) return;
          // Only Host should push most structural changes, but Guests trigger spins via Host or receive updates
          // Here we assume simple trust: whoever changes state pushes it if allowed.
          if (this.isHost || key === "questions") {
            this.roomRef.update({ [key]: data });
          }
        },
      };

      /* ==================== Data Module ==================== */
      const DataModule = {
        key: "luxuryTOD_v3",
        defaultDB: [
          ...QUESTIONS_EASY,
          ...QUESTIONS_NORMAL,
          ...QUESTIONS_HARD,
          ...QUESTIONS_ADULT,
        ],
        state: {
          players: [],
          questions: [],
          history: [],
          usedQuestions: [],
          playerQuestionHistory: {},
          stats: {},
          settings: {
            speed: 30,
            duration: 5000,
            difficultyFilter: "All",
            segmentCounts: { truth: 10, dare: 10, pass: 2 },
            noRepeat: false,
            noRepeatQuestions: false,
            noRepeatPersonal: false,
            autoReduceWeight: false,
          },
        },
        tempSelected: [],
        init() {
          // Default init
          this.state.questions = [...this.defaultDB];
          this.loadFromStorage();
        },
        loadFromStorage() {
          const saved = localStorage.getItem(this.key);
          if (saved) {
            const parsed = JSON.parse(saved);
            this.state = { ...this.state, ...parsed };
            // Migration for old difficulty filter
            if (this.state.settings.difficultyFilter === "Any")
              this.state.settings.difficultyFilter = "All";
            // Migration for players (string -> object)
            if (
              this.state.players.length > 0 &&
              typeof this.state.players[0] === "string"
            ) {
              this.state.players = this.state.players.map((name) => ({
                name,
                weight: 50,
              }));
            }
            // Migration for noRepeat
            if (this.state.settings.noRepeat === undefined) {
              this.state.settings.noRepeat = false;
            }
            if (this.state.settings.noRepeatQuestions === undefined) {
              this.state.settings.noRepeatQuestions = false;
            }
            if (this.state.settings.autoReduceWeight === undefined) {
              this.state.settings.autoReduceWeight = false;
            }
            if (this.state.settings.noRepeatPersonal === undefined) {
              this.state.settings.noRepeatPersonal = false;
            }
          }
        },
        saveToStorage() {
          localStorage.setItem(this.key, JSON.stringify(this.state));
        },
        resetToDefault() {
          if (
            confirm("ç¢ºå®šè¦æ¢å¾©é è¨­å€¼å—ï¼Ÿæ‰€æœ‰è‡ªè¨‚é¡Œç›®ã€ç©å®¶èˆ‡ç´€éŒ„å°‡è¢«æ¸…é™¤ã€‚")
          ) {
            localStorage.removeItem(this.key);
            location.reload();
          }
        },
        // Methods modified to sync with Network
        addPlayer(name) {
          if (NetworkModule.roomId !== "LOCAL") {
            // ç·šä¸Šæ¨¡å¼ï¼šå¯«å…¥ç¯€é»
            const safeName = name.replace(/[.$#\[\]\/]/g, "_");
            NetworkModule.roomRef
              .child("players/" + safeName)
              .set({ name: name, isHost: false, weight: 50 });
            return true;
          } else if (!this.state.players.some((p) => p.name === name)) {
            // å–®æ©Ÿæ¨¡å¼
            this.state.players.push({ name: name, weight: 50 });
            this.saveToStorage();
            UIModule.renderPlayerList();
            return true;
          }
          return false;
        },
        removePlayer(index) {
          const p = this.state.players[index];
          if (!p) return;
          const name = p.name;

          if (NetworkModule.roomId !== "LOCAL") {
            // ç·šä¸Šæ¨¡å¼ï¼šç§»é™¤ç¯€é»
            const safeName = name.replace(/[.$#\[\]\/]/g, "_");
            NetworkModule.roomRef.child("players/" + safeName).remove();
          } else {
            // å–®æ©Ÿæ¨¡å¼
            this.state.players.splice(index, 1);
            this.saveToStorage();
            UIModule.renderPlayerList();
          }
        },
        updatePlayerWeight(index, weight) {
          const w = parseInt(weight);
          if (isNaN(w) || w < 0) return;
          const p = this.state.players[index];
          if (!p) return;

          if (NetworkModule.roomId !== "LOCAL") {
            const safeName = p.name.replace(/[.$#\[\]\/]/g, "_");
            NetworkModule.roomRef
              .child("players/" + safeName)
              .update({ weight: w });
          } else {
            p.weight = w;
            this.saveToStorage();
          }
        },
        resetAllWeights() {
          if (NetworkModule.roomId !== "LOCAL") {
            // ç·šä¸Šæ¨¡å¼ï¼šå»ºç«‹å¤šè·¯å¾‘æ›´æ–°ä»¥ä¸€æ¬¡æ€§é‡ç½®æ‰€æœ‰ç©å®¶æ¬Šé‡
            const updates = {};
            this.state.players.forEach((p) => {
              const safeName = p.name.replace(/[.$#\[\]\/]/g, "_");
              updates["players/" + safeName + "/weight"] = 50;
            });
            if (Object.keys(updates).length > 0) {
              NetworkModule.roomRef.update(updates);
            }
          } else {
            // å–®æ©Ÿæ¨¡å¼
            this.state.players.forEach((p) => (p.weight = 50));
            this.saveToStorage();
            UIModule.renderPlayerList();
          }
        },
        addQuestion(q) {
          this.state.questions.push(q);
          this.saveToStorage();
          NetworkModule.pushUpdate("questions", this.state.questions);
          UIModule.renderQuestionList();
        },
        removeQuestion(index) {
          this.state.questions.splice(index, 1);
          this.saveToStorage();
          NetworkModule.pushUpdate("questions", this.state.questions);
          UIModule.renderQuestionList();
        },
        clearQuestions() {
          this.state.questions = [];
          this.saveToStorage();
          NetworkModule.pushUpdate("questions", this.state.questions);
          UIModule.renderQuestionList();
        },
        addHistory(item) {
          this.state.history.unshift(item);
          if (this.state.history.length > 50) this.state.history.pop();
          this.saveToStorage();
          NetworkModule.pushUpdate("history", this.state.history);
        },
        clearHistory() {
          this.state.history = [];
          this.saveToStorage();
          NetworkModule.pushUpdate("history", this.state.history);
        },
        markQuestionAsUsed(content) {
          if (!this.state.usedQuestions) this.state.usedQuestions = [];
          this.state.usedQuestions.push(content);
          this.saveToStorage();
          NetworkModule.pushUpdate("usedQuestions", this.state.usedQuestions);
        },
        resetUsedQuestions() {
          this.state.usedQuestions = [];
          this.saveToStorage();
          NetworkModule.pushUpdate("usedQuestions", this.state.usedQuestions);
        },
        markQuestionAsUsedByPlayer(player, content) {
          if (!this.state.playerQuestionHistory)
            this.state.playerQuestionHistory = {};
          if (!this.state.playerQuestionHistory[player])
            this.state.playerQuestionHistory[player] = [];
          this.state.playerQuestionHistory[player].push(content);
          this.saveToStorage();
          NetworkModule.pushUpdate(
            "playerQuestionHistory",
            this.state.playerQuestionHistory
          );
        },
        resetPersonalHistory(player) {
          if (
            this.state.playerQuestionHistory &&
            this.state.playerQuestionHistory[player]
          ) {
            this.state.playerQuestionHistory[player] = [];
            this.saveToStorage();
            NetworkModule.pushUpdate(
              "playerQuestionHistory",
              this.state.playerQuestionHistory
            );
          }
        },
        removePersonalHistoryItem(player, index) {
          if (
            this.state.playerQuestionHistory &&
            this.state.playerQuestionHistory[player]
          ) {
            this.state.playerQuestionHistory[player].splice(index, 1);
            this.saveToStorage();
            NetworkModule.pushUpdate(
              "playerQuestionHistory",
              this.state.playerQuestionHistory
            );
            if (player === NetworkModule.nickname) {
              UIModule.showPersonalHistory();
            }
          }
        },
        incrementStat(name) {
          if (!this.state.stats) this.state.stats = {};
          this.state.stats[name] = (this.state.stats[name] || 0) + 1;
          this.saveToStorage();
          NetworkModule.pushUpdate("stats", this.state.stats);
        },
        resetStats() {
          this.state.stats = {};
          this.saveToStorage();
          NetworkModule.pushUpdate("stats", this.state.stats);
        },
        updateSettings() {
          this.saveToStorage();
          NetworkModule.pushUpdate("settings", this.state.settings);
        },

        // Helpers
        getQuestionByType(type, player) {
          let filtered = this.state.questions.filter((q) => q.type === type);
          const filterLevel = this.state.settings.difficultyFilter;

          if (filterLevel === "Safe") {
            filtered = filtered.filter((q) =>
              ["Easy", "Normal"].includes(q.level)
            );
          } else if (filterLevel === "Standard") {
            filtered = filtered.filter((q) =>
              ["Easy", "Normal", "Hard"].includes(q.level)
            );
          } else if (filterLevel === "Spicy") {
            filtered = filtered.filter((q) =>
              ["Hard", "Adult"].includes(q.level)
            );
          } else if (filterLevel === "Adult") {
            filtered = filtered.filter((q) => q.level === "Adult");
          }
          // "All" returns everything

          // No Repeat Logic for Questions
          let wasReset = false;
          if (this.state.settings.noRepeatQuestions && filtered.length > 0) {
            const available = filtered.filter(
              (q) => !this.state.usedQuestions.includes(q.content)
            );
            if (available.length === 0) {
              let reset = false;
              if (NetworkModule.isHost) {
                if (
                  confirm(
                    "æ­¤é¡åˆ¥/ç­‰ç´šçš„é¡Œç›®å·²å…¨éƒ¨æŠ½å®Œï¼\næ˜¯å¦è¦é‡ç½®ã€Œå·²ä½¿ç”¨é¡Œç›®ã€è¨˜éŒ„ä¸¦é‡æ–°æŠ½å–ï¼Ÿ"
                  )
                ) {
                  this.resetUsedQuestions();
                  reset = true;
                  wasReset = true;
                }
              }
              if (!reset) {
                return {
                  content: "æ­¤é¡åˆ¥é¡Œç›®å·²å…¨éƒ¨æŠ½å®Œï¼è«‹é‡ç½®æˆ–é—œé–‰é˜²é‡è¤‡ã€‚",
                  level: "",
                };
              }
            } else {
              filtered = available;
            }
          }

          // Personal No Repeat Logic
          if (
            this.state.settings.noRepeatPersonal &&
            player &&
            filtered.length > 0
          ) {
            const history = this.state.playerQuestionHistory || {};
            const playerHistory = history[player] || [];
            const available = filtered.filter(
              (q) => !playerHistory.includes(q.content)
            );

            if (available.length === 0) {
              let reset = false;
              if (NetworkModule.isHost) {
                if (
                  confirm(
                    `ç©å®¶ ${player} çš„æ­¤é¡åˆ¥/ç­‰ç´šé¡Œç›®å·²å…¨éƒ¨æŠ½å®Œï¼\næ˜¯å¦é‡ç½®è©²ç©å®¶çš„ã€Œå·²æŠ½éé¡Œç›®ã€è¨˜éŒ„ä¸¦é‡æ–°æŠ½å–ï¼Ÿ`
                  )
                ) {
                  this.resetPersonalHistory(player);
                  reset = true;
                  wasReset = true;
                }
              }
              if (!reset) {
                return {
                  content: `ç©å®¶ ${player} çš„é¡Œç›®å·²å…¨éƒ¨æŠ½å®Œï¼`,
                  level: "",
                };
              }
            } else {
              filtered = available;
            }
          }

          if (filtered.length === 0) return { content: "ç„¡ç¬¦åˆæ¢ä»¶çš„é¡Œç›®" };

          const selected =
            filtered[Math.floor(Math.random() * filtered.length)];

          // Mark as used if setting is enabled
          if (this.state.settings.noRepeatQuestions) {
            this.markQuestionAsUsed(selected.content);
          }

          if (this.state.settings.noRepeatPersonal && player) {
            this.markQuestionAsUsedByPlayer(player, selected.content);
          }

          return { ...selected, isReset: wasReset };
        },
        getRandomPlayer() {
          if (this.state.players.length === 0) return "åŒ¿åç©å®¶";

          let candidates = this.state.players;

          // No Repeat Logic
          if (this.state.settings.noRepeat) {
            // Filter out players who are already in tempSelected
            // Ensure tempSelected only contains current valid players
            this.tempSelected = this.tempSelected.filter((name) =>
              this.state.players.some((p) => p.name === name)
            );

            const unpicked = this.state.players.filter(
              (p) => !this.tempSelected.includes(p.name)
            );

            if (unpicked.length === 0) {
              // All picked, reset
              this.tempSelected = [];
              candidates = this.state.players;
            } else {
              candidates = unpicked;
            }
          }

          const totalWeight = candidates.reduce(
            (sum, p) => sum + (p.weight || 0),
            0
          );
          let selectedName = "";

          if (totalWeight <= 0) {
            selectedName =
              candidates[Math.floor(Math.random() * candidates.length)].name;
          } else {
            let r = Math.random() * totalWeight;
            for (const p of candidates) {
              const w = p.weight || 0;
              if (r < w) {
                selectedName = p.name;
                break;
              }
              r -= w;
            }
            if (!selectedName)
              selectedName = candidates[candidates.length - 1].name;
          }

          if (this.state.settings.noRepeat) {
            this.tempSelected.push(selectedName);
          }

          return selectedName;
        },
        aiGenerate() {
          const types = ["truth", "dare"];
          const newQ = {
            type: types[Math.floor(Math.random() * 2)],
            content: `(AIç”Ÿæˆ) è«‹è©³ç´°æè¿°ä½ å°${Math.floor(
              Math.random() * 100
            )}è™Ÿè©±é¡Œçš„çœ‹æ³•ã€‚`,
            level: "Normal",
          };
          this.addQuestion(newQ);
          return true;
        },
        exportData() {
          const dataStr = JSON.stringify(this.state, null, 2);
          const blob = new Blob([dataStr], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `backup_${Date.now()}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        },
        importData(jsonStr) {
          try {
            const data = JSON.parse(jsonStr);
            if (data.players && data.questions) {
              // Migration
              if (
                data.players.length > 0 &&
                typeof data.players[0] === "string"
              ) {
                data.players = data.players.map((name) => ({
                  name,
                  weight: 50,
                }));
              }
              this.state = data;
              this.saveToStorage();
              // If Host, sync to everyone
              if (NetworkModule.isHost) {
                NetworkModule.pushUpdate("players", this.state.players);
                NetworkModule.pushUpdate("questions", this.state.questions);
                NetworkModule.pushUpdate("settings", this.state.settings);
              }
              return true;
            }
          } catch (e) {}
          return false;
        },
      };

      /* ==================== Wheel Module ==================== */
      const WheelModule = {
        canvas: null,
        ctx: null,
        pointerEl: null,
        segments: [],
        angleCurrent: 0,
        angleDelta: 0,
        isSpinning: false,
        spinTime: 0,
        spinTimeTotal: 0,
        startTime: 0,
        startAngle: 0,
        targetAngle: 0,
        requestFrameId: null,

        init() {
          this.canvas = document.getElementById("wheelCanvas");
          this.ctx = this.canvas.getContext("2d");
          this.pointerEl = document.querySelector(".pointer");
          this.generateSegments();
          this.draw();
        },
        generateSegments() {
          const { truth, dare, pass } = DataModule.state.settings.segmentCounts;
          const tPool = Array(parseInt(truth)).fill({
            text: "çœŸå¿ƒè©±",
            type: "truth",
            color: "#1565C0",
            txtColor: "#FFF",
          });
          const dPool = Array(parseInt(dare)).fill({
            text: "å¤§å†’éšª",
            type: "dare",
            color: "#C62828",
            txtColor: "#FFF",
          });
          const pPool = Array(parseInt(pass)).fill({
            text: "Pass",
            type: "pass",
            color: "#D4AF37",
            txtColor: "#000",
          });

          let combined = [];
          const max = Math.max(truth, dare, pass);
          for (let i = 0; i < max; i++) {
            if (tPool[i]) combined.push(tPool[i]);
            if (dPool[i]) combined.push(dPool[i]);
            if (pPool[i]) combined.push(pPool[i]);
          }
          if (combined.length === 0)
            combined.push({
              text: "è¨­å®š",
              type: "pass",
              color: "#888",
              txtColor: "#FFF",
            });
          this.segments = combined;
        },
        draw() {
          const ctx = this.ctx;
          const w = this.canvas.width;
          const h = this.canvas.height;
          const cx = w / 2;
          const cy = h / 2;
          const radius = w / 2 - 10;
          const count = this.segments.length;
          const arc = (Math.PI * 2) / count;

          ctx.clearRect(0, 0, w, h);
          for (let i = 0; i < count; i++) {
            const angle = this.angleCurrent + i * arc;
            const seg = this.segments[i];
            ctx.fillStyle = seg.color;
            ctx.beginPath();
            ctx.moveTo(cx, cy);
            ctx.arc(cx, cy, radius, angle, angle + arc);
            ctx.fill();
            ctx.save();
            ctx.translate(
              cx + Math.cos(angle + arc / 2) * (radius - 50),
              cy + Math.sin(angle + arc / 2) * (radius - 50)
            );
            ctx.rotate(angle + arc / 2 + Math.PI / 2);
            ctx.fillStyle = seg.txtColor;
            ctx.font = 'bold 14px "Noto Sans TC"';
            ctx.fillText(seg.text, -ctx.measureText(seg.text).width / 2, 0);
            ctx.restore();
          }
        },
        spin(isInitiator = true) {
          // åœæ­¢éœ‡å‹•èˆ‡é¬§é˜ç›¸é—œæ•ˆæœ
          if (navigator.vibrate) navigator.vibrate(0);
          document.body.classList.remove("shake-screen");
          document
            .getElementById("timer-display")
            .classList.remove("timer-blink");
          AudioModule.stop("alarm");

          if (this.isSpinning) return;
          this.isSpinning = true;
          document.querySelector(".game-info").style.background =
            "rgba(0, 0, 0, 0.6)";

          if (isInitiator) {
            // Host triggers network event
            if (
              NetworkModule.roomRef &&
              (NetworkModule.isHost ||
                NetworkModule.nickname === NetworkModule.nextSpinner)
            ) {
              NetworkModule.roomRef.update({
                spinTrigger: firebase.database.ServerValue.TIMESTAMP,
              });
            }
          }

          const speedMult = DataModule.state.settings.speed / 10;
          this.spinTimeTotal =
            DataModule.state.settings.duration * (0.8 + Math.random() * 0.4);
          this.startTime = null;
          this.startAngle = this.angleCurrent;

          // è¨ˆç®—ç›®æ¨™è§’åº¦ï¼šåŸºç¤åœˆæ•¸ + éš¨æ©Ÿåœˆæ•¸ï¼Œä½¿ç”¨ EaseOutQuart æ¨¡æ“¬æ‘©æ“¦åŠ›
          const rotations = (5 + Math.random() * 5) * speedMult;
          const totalRadians = rotations * 2 * Math.PI;
          this.targetAngle = this.startAngle + totalRadians;

          AudioModule.play("spin");
          this.requestFrameId = requestAnimationFrame(this.rotate.bind(this));
        },
        rotate(timestamp) {
          if (!this.startTime) this.startTime = timestamp;
          const elapsed = timestamp - this.startTime;

          if (elapsed >= this.spinTimeTotal) {
            this.angleCurrent = this.targetAngle;
            this.draw();
            this.stop();
            return;
          }

          const t = elapsed / this.spinTimeTotal;

          // å„ªåŒ–ï¼šä½¿ç”¨å¸¶æœ‰å›å½ˆæ•ˆæœçš„ç·©å‹•å‡½æ•¸ (Modified EaseOutBack)
          // æ¨¡æ“¬é‡è¼ªç›¤çš„æ‘©æ“¦åŠ›èˆ‡æœ€å¾Œçš„ç‰©ç†å›å½ˆ
          const ts = t - 1;
          const recoil = 0.2; // å›å½ˆä¿‚æ•¸ï¼Œæ•¸å€¼è¶Šå¤§å›å½ˆè¶Šæ˜é¡¯
          const ease =
            1 + ((recoil + 1) * Math.pow(ts, 3) + recoil * Math.pow(ts, 2));

          const newAngle =
            this.startAngle + (this.targetAngle - this.startAngle) * ease;

          // è¨ˆç®—é€Ÿåº¦ä¸¦æ‡‰ç”¨æŒ‡é‡æ“ºå‹•å‹•ç•«
          const speed = newAngle - this.angleCurrent;
          this.angleCurrent = newAngle;

          if (this.pointerEl) {
            const count = this.segments.length;
            // æ¨¡æ“¬æŒ‡é‡æ’æ“Šæ ¼å­çš„æ•ˆæœï¼šsinæ³¢å½¢ * é€Ÿåº¦ * å¼·åº¦ä¿‚æ•¸
            const wobble = Math.sin(this.angleCurrent * count) * speed * 200;
            this.pointerEl.style.transform = `translateX(-50%) rotate(${wobble}deg)`;
          }

          this.draw();
          this.requestFrameId = requestAnimationFrame(this.rotate.bind(this));
        },
        stop() {
          this.isSpinning = false;
          cancelAnimationFrame(this.requestFrameId);
          if (this.pointerEl) {
            this.pointerEl.style.transform = "translateX(-50%) rotate(0deg)";
          }
          AudioModule.stop("spin");
          AudioModule.play("win");

          const count = this.segments.length;
          const arc = (Math.PI * 2) / count;
          const rotation = this.angleCurrent % (Math.PI * 2);
          let index = Math.floor((Math.PI * 1.5 - rotation) / arc);
          index = ((index % count) + count) % count;
          const result = this.segments[index];

          // åªæœ‰æˆ¿ä¸»è² è²¬å¯«å…¥çµæœèˆ‡çµ±è¨ˆ
          if (NetworkModule.isHost) {
            const player = DataModule.getRandomPlayer();

            // Auto Reduce Weight Logic
            if (DataModule.state.settings.autoReduceWeight) {
              const pIndex = DataModule.state.players.findIndex(
                (p) => p.name === player
              );
              if (pIndex !== -1) {
                const currentW =
                  DataModule.state.players[pIndex].weight !== undefined
                    ? DataModule.state.players[pIndex].weight
                    : 50;
                if (currentW > 0)
                  DataModule.updatePlayerWeight(pIndex, currentW - 1);
              }
            }

            const qObj =
              result.type === "pass"
                ? { content: "ç›´æ¥è·³éï¼", level: "", isReset: false }
                : DataModule.getQuestionByType(result.type, player);
            const content = qObj.content;
            const level = qObj.level || "";
            const isReset = qObj.isReset || false;

            DataModule.incrementStat(player);
            DataModule.addHistory({
              player,
              type: result.type,
              content,
              isReset,
              time: new Date().toLocaleTimeString("en-GB", {
                hour: "2-digit",
                minute: "2-digit",
              }),
            });

            if (NetworkModule.roomRef) {
              NetworkModule.roomRef.update({
                currentResult: {
                  type: result.type,
                  content,
                  player,
                  level,
                  isReset,
                  timestamp: firebase.database.ServerValue.TIMESTAMP,
                },
                nextSpinner: player,
              });
            }
            UIModule.showResult(result.type, content, player, level, isReset);
          } else if (NetworkModule.roomId === "LOCAL") {
            // å–®æ©Ÿæ¨¡å¼
            const player = DataModule.getRandomPlayer();

            // Auto Reduce Weight Logic
            if (DataModule.state.settings.autoReduceWeight) {
              const pIndex = DataModule.state.players.findIndex(
                (p) => p.name === player
              );
              if (pIndex !== -1) {
                const currentW =
                  DataModule.state.players[pIndex].weight !== undefined
                    ? DataModule.state.players[pIndex].weight
                    : 50;
                if (currentW > 0)
                  DataModule.updatePlayerWeight(pIndex, currentW - 1);
              }
            }

            const qObj =
              result.type === "pass"
                ? { content: "ç›´æ¥è·³éï¼", level: "", isReset: false }
                : DataModule.getQuestionByType(result.type, player);
            const content = qObj.content;
            const level = qObj.level || "";
            const isReset = qObj.isReset || false;

            DataModule.incrementStat(player);
            DataModule.addHistory({
              player,
              type: result.type,
              content,
              isReset,
              time: new Date().toLocaleTimeString("en-GB", {
                hour: "2-digit",
                minute: "2-digit",
              }),
            });
            UIModule.showResult(result.type, content, player, level, isReset);
          } else {
            // è¨ªå®¢ï¼šåªé¡¯ç¤ºç‰¹æ•ˆï¼Œç­‰å¾… Firebase çš„ currentResult åŒæ­¥å…§å®¹
            EffectModule.triggerConfetti();
            if (NetworkModule.pendingResult) {
              UIModule.showResult(
                NetworkModule.pendingResult.type,
                NetworkModule.pendingResult.content,
                NetworkModule.pendingResult.player,
                NetworkModule.pendingResult.level,
                NetworkModule.pendingResult.isReset
              );
              NetworkModule.pendingResult = null;
            }
          }
        },
      };

      /* ==================== UI & Audio & Effect ==================== */
      const UIModule = {
        currentQuestionFilter: "all",
        init() {
          this.bindEvents();
          this.renderSettingsValues();
          this.updateSpinPermission();
          WheelModule.init();
          AudioModule.init();
        },
        bindEvents() {
          document
            .getElementById("spinBtn")
            .addEventListener("click", () => WheelModule.spin(true));
          document
            .getElementById("menu-toggle")
            .addEventListener("click", () =>
              document.body.classList.toggle("sidebar-collapsed")
            );
          document
            .getElementById("add-player-btn")
            .addEventListener("click", () => {
              const input = document.getElementById("new-player-input");
              if (input.value) {
                DataModule.addPlayer(input.value);
                input.value = "";
              }
            });
          document
            .getElementById("check-auto-reduce")
            .addEventListener("change", (e) => {
              DataModule.state.settings.autoReduceWeight = e.target.checked;
              DataModule.updateSettings();
            });
          document
            .getElementById("reset-weights-btn")
            .addEventListener("click", () => {
              if (confirm("ç¢ºå®šè¦å°‡æ‰€æœ‰ç©å®¶çš„æ¬Šé‡é‡ç½®ç‚º 50 å—ï¼Ÿ"))
                DataModule.resetAllWeights();
            });
          document.getElementById("add-q-btn").addEventListener("click", () => {
            const input = document.getElementById("new-q-input");
            if (input.value) {
              DataModule.addQuestion({
                type: document.getElementById("q-type").value,
                content: input.value,
                level: "Normal",
              });
              input.value = "";
            }
          });
          document
            .getElementById("clear-q-btn")
            .addEventListener("click", () => {
              if (confirm("æ¸…ç©º?")) DataModule.clearQuestions();
            });
          document
            .getElementById("reset-used-btn")
            .addEventListener("click", () => {
              if (confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å·²ä½¿ç”¨çš„é¡Œç›®å—ï¼Ÿ"))
                DataModule.resetUsedQuestions();
            });
          document
            .getElementById("ai-generate-btn")
            .addEventListener("click", () => DataModule.aiGenerate());
          document
            .getElementById("btn-my-history")
            .addEventListener("click", () => {
              UIModule.showPersonalHistory();
            });
          document
            .getElementById("clear-history-btn")
            .addEventListener("click", () => DataModule.clearHistory());
          document
            .getElementById("reset-stats-btn")
            .addEventListener("click", () => DataModule.resetStats());

          // Settings Inputs
          ["range-truth", "range-dare", "range-pass"].forEach((id) => {
            document.getElementById(id).addEventListener("input", () => {
              const t = document.getElementById("range-truth").value;
              const d = document.getElementById("range-dare").value;
              const p = document.getElementById("range-pass").value;

              // Update bubbles
              UIModule.updateBubble(
                document.getElementById("range-truth"),
                document.getElementById("val-truth")
              );
              UIModule.updateBubble(
                document.getElementById("range-dare"),
                document.getElementById("val-dare")
              );
              UIModule.updateBubble(
                document.getElementById("range-pass"),
                document.getElementById("val-pass")
              );

              DataModule.state.settings.segmentCounts = {
                truth: t,
                dare: d,
                pass: p,
              };
              WheelModule.generateSegments();
              WheelModule.draw();
              DataModule.updateSettings();
            });
          });
          document
            .getElementById("check-no-repeat")
            .addEventListener("change", (e) => {
              DataModule.state.settings.noRepeat = e.target.checked;
              DataModule.updateSettings();
            });
          document
            .getElementById("check-no-repeat-q")
            .addEventListener("change", (e) => {
              DataModule.state.settings.noRepeatQuestions = e.target.checked;
              DataModule.updateSettings();
            });
          document
            .getElementById("check-no-repeat-personal")
            .addEventListener("change", (e) => {
              DataModule.state.settings.noRepeatPersonal = e.target.checked;
              DataModule.updateSettings();
            });
          document
            .getElementById("game-difficulty-filter")
            .addEventListener("change", (e) => {
              DataModule.state.settings.difficultyFilter = e.target.value;
              DataModule.updateSettings();
            });
          document
            .getElementById("speed-range")
            .addEventListener("input", (e) => {
              DataModule.state.settings.speed = parseInt(e.target.value);
              DataModule.updateSettings();
            });
          document
            .getElementById("duration-range")
            .addEventListener("input", (e) => {
              DataModule.state.settings.duration =
                parseInt(e.target.value) * 1000;
              DataModule.updateSettings();
            });
          // Import/Export
          document
            .getElementById("btn-export")
            .addEventListener("click", () => DataModule.exportData());
          document
            .getElementById("btn-import")
            .addEventListener("click", () =>
              document.getElementById("file-import").click()
            );
          document
            .getElementById("btn-reset-default")
            .addEventListener("click", () => DataModule.resetToDefault());
          document
            .getElementById("btn-leave-room")
            .addEventListener("click", () => {
              if (confirm("ç¢ºå®šè¦é€€å‡ºæˆ¿é–“å—ï¼Ÿ")) NetworkModule.leaveRoom();
            });
          document
            .getElementById("file-import")
            .addEventListener("change", (e) => {
              const reader = new FileReader();
              reader.onload = (ev) => {
                if (DataModule.importData(ev.target.result)) location.reload();
              };
              if (e.target.files[0]) reader.readAsText(e.target.files[0]);
            });

          // Tabs
          document.querySelectorAll(".diff-tab").forEach((tab) => {
            tab.addEventListener("click", (e) => {
              const parent = tab.parentElement;
              if (parent.id === "diff-selector") {
                parent
                  .querySelectorAll(".diff-tab")
                  .forEach((t) => t.classList.remove("active"));
                e.target.classList.add("active");
                UIModule.renderQuestionList(e.target.dataset.val);
              } else if (parent.id === "timer-mode-selector") {
                parent
                  .querySelectorAll(".diff-tab")
                  .forEach((t) => t.classList.remove("active"));
                e.target.classList.add("active");
                TimerModule.switchMode(e.target.dataset.mode);
              }
            });
          });

          document
            .getElementById("list-difficulty-filter")
            .addEventListener("change", () => {
              UIModule.renderQuestionList();
            });

          // Keyboard
          document.addEventListener("keydown", (e) => {
            if (
              ["input", "select"].includes(
                document.activeElement.tagName.toLowerCase()
              )
            )
              return;
            if (
              e.code === "Space" &&
              document.getElementById("panel-home").classList.contains("active")
            ) {
              e.preventDefault();
              const btn = document.getElementById("spinBtn");
              if (!btn.disabled) WheelModule.spin(true);
            }
            if (e.code === "Escape") this.switchPanel("panel-home");
          });
        },
        switchPanel(id, btn) {
          document
            .querySelectorAll(".panel")
            .forEach((p) => p.classList.remove("active"));
          document.getElementById(id).classList.add("active");
          document
            .querySelectorAll(".nav-btn")
            .forEach((b) => b.classList.remove("active"));
          if (btn) btn.classList.add("active");
          else {
            // Auto active nav
          }
          if (id === "panel-leaderboard") this.renderLeaderboard();
        },
        updateRoleUI() {
          if (NetworkModule.isHost) {
            document
              .querySelectorAll(".host-only")
              .forEach((el) => el.classList.remove("guest-hidden"));
            document
              .querySelectorAll(".guest-hidden-ctrl")
              .forEach((el) => (el.style.display = ""));
            document.getElementById("guest-msg").classList.add("guest-hidden");
            document
              .querySelectorAll(".host-control")
              .forEach((el) => (el.disabled = false));
            this.updateSpinPermission();
          } else {
            document
              .querySelectorAll(".host-only")
              .forEach((el) => el.classList.add("guest-hidden"));
            document
              .getElementById("guest-msg")
              .classList.remove("guest-hidden");
            document
              .querySelectorAll(".host-control")
              .forEach((el) => (el.disabled = true));
            this.updateSpinPermission();
          }
        },
        updateSpinPermission() {
          const btn = document.getElementById("spinBtn");
          if (NetworkModule.roomId === "LOCAL") {
            btn.disabled = false;
            btn.innerText = "é–‹å§‹æŠ½ç±¤";
            return;
          }
          const isMe = NetworkModule.nickname === NetworkModule.nextSpinner;
          if (NetworkModule.isHost || isMe) {
            btn.disabled = false;
            btn.innerText = isMe ? "è¼ªåˆ°ä½ äº†ï¼é–‹å§‹æŠ½ç±¤" : "é–‹å§‹æŠ½ç±¤ (Host)";
          } else {
            btn.disabled = true;
            btn.innerText = NetworkModule.nextSpinner
              ? `ç­‰å¾… ${NetworkModule.nextSpinner} æŠ½ç±¤`
              : "ç­‰å¾…æˆ¿ä¸»é–‹å§‹";
          }
        },
        renderPlayerList() {
          const list = document.getElementById("player-list");
          let html = "";
          DataModule.state.players.forEach((p, i) => {
            const isHost = NetworkModule.isHost;
            const weight = p.weight !== undefined ? p.weight : 50;
            const zeroClass = weight === 0 ? "zero-weight" : "";

            const weightInput = isHost
              ? `<div style="display:flex; align-items:center; margin-right:5px" onclick="event.stopPropagation()">
                   <input type="range" style="width:80px; accent-color:var(--gold); margin-right:5px; cursor:pointer; padding:0" value="${weight}" min="0" max="100" 
                   oninput="document.getElementById('w-val-${i}').innerText=this.value" 
                   onchange="DataModule.updatePlayerWeight(${i}, this.value)">
                   <span id="w-val-${i}" style="width:30px; text-align:center; color:var(--gold); font-weight:bold">${weight}</span>
                 </div>`
              : `<span style="font-size:0.8rem; color:#888; margin-right:5px">æ¬Šé‡: ${weight}</span>`;

            const delBtn = isHost
              ? `<button class="delete-btn" onclick="DataModule.removePlayer(${i})"><i class="material-icons">delete</i></button>`
              : "";

            html += `<div class="list-item ${zeroClass}">
                <div style="display:flex; align-items:center; flex:1">
                    <i class="material-icons" style="font-size:16px; margin-right:5px">person</i> 
                    <span>${p.name}</span>
                </div>
                <div style="display:flex; align-items:center; gap:5px">${weightInput}${delBtn}</div>
            </div>`;
          });
          list.innerHTML = html;
          document.getElementById("player-count").innerText =
            DataModule.state.players.length;
        },
        renderQuestionList(filterType) {
          if (filterType) this.currentQuestionFilter = filterType;
          const list = document.getElementById("question-list");
          const levelFilter = document.getElementById(
            "list-difficulty-filter"
          ).value;
          const usedList = DataModule.state.usedQuestions || [];

          list.innerHTML = "";
          DataModule.state.questions.forEach((q, i) => {
            if (
              this.currentQuestionFilter !== "all" &&
              q.type !== this.currentQuestionFilter
            )
              return;
            if (levelFilter !== "all" && q.level !== levelFilter) return;

            const isUsed = usedList.includes(q.content);
            const usedClass = isUsed ? "used" : "";

            // Simplified render
            const delBtn = NetworkModule.isHost
              ? `<button class="delete-btn" onclick="DataModule.removeQuestion(${i})"><i class="material-icons">delete</i></button>`
              : "";
            list.innerHTML += `<div class="list-item ${
              q.type === "truth" ? "truth" : "dare"
            } ${usedClass}"><div><span class="tag">${q.type}</span>${
              q.content
            }</div>${delBtn}</div>`;
          });
        },
        renderHistory() {
          const list = document.getElementById("history-list");
          list.innerHTML = "";
          DataModule.state.history.forEach((h) => {
            const resetBadge = h.isReset
              ? `<span class="reset-badge" style="font-size:0.6rem; padding:1px 4px; margin-left:5px; animation:none">â™»ï¸</span>`
              : "";
            list.innerHTML += `<div class="list-item ${h.type}"><div><div style="color:var(--gold)">${h.player}</div>${h.content}${resetBadge} <span style="font-size:0.7rem; color:#666">${h.time}</span></div></div>`;
          });
        },
        showPersonalHistory() {
          const player = NetworkModule.nickname;
          const history = DataModule.state.playerQuestionHistory || {};
          const list = history[player] || [];
          const container = document.getElementById("personal-history-list");

          container.innerHTML = "";
          if (list.length === 0) {
            container.innerHTML = `<div style="text-align:center; color:#888; padding:20px">å°šç„¡è¨˜éŒ„</div>`;
          } else {
            list.forEach((content, i) => {
              container.innerHTML += `<div class="list-item used"><div style="flex:1"><span class="tag" style="background:#666">#${
                i + 1
              }</span>${content}</div><button class="delete-btn" onclick="DataModule.removePersonalHistoryItem(NetworkModule.nickname, ${i})"><i class="material-icons">delete</i></button></div>`;
            });
          }
          document
            .getElementById("personal-history-overlay")
            .classList.remove("hidden");
        },
        renderLeaderboard() {
          const list = document.getElementById("leaderboard-list");
          list.innerHTML = "";
          const stats = Object.entries(DataModule.state.stats)
            .map(([k, v]) => ({ name: k, count: v }))
            .sort((a, b) => b.count - a.count);
          stats.forEach((p, i) => {
            let cls =
              i === 0 ? "rank-1" : i === 1 ? "rank-2" : i === 2 ? "rank-3" : "";
            list.innerHTML += `<div class="list-item ${cls}"><span>#${i + 1} ${
              p.name
            }</span><span class="rank-count">${p.count}</span></div>`;
          });
        },
        renderSettingsValues() {
          const s = DataModule.state.settings;
          document.getElementById("val-truth").innerText =
            s.segmentCounts.truth;
          document.getElementById("val-dare").innerText = s.segmentCounts.dare;
          document.getElementById("val-pass").innerText = s.segmentCounts.pass;
          document.getElementById("range-truth").value = s.segmentCounts.truth;
          document.getElementById("range-dare").value = s.segmentCounts.dare;
          document.getElementById("range-pass").value = s.segmentCounts.pass;
          document.getElementById("speed-range").value = s.speed;
          document.getElementById("duration-range").value = s.duration / 1000;

          // Update bubbles position on load/sync
          this.updateBubble(
            document.getElementById("range-truth"),
            document.getElementById("val-truth")
          );
          this.updateBubble(
            document.getElementById("range-dare"),
            document.getElementById("val-dare")
          );
          this.updateBubble(
            document.getElementById("range-pass"),
            document.getElementById("val-pass")
          );

          document.getElementById("game-difficulty-filter").value =
            s.difficultyFilter;
          document.getElementById("check-no-repeat").checked = !!s.noRepeat;
          document.getElementById("check-no-repeat-q").checked =
            !!s.noRepeatQuestions;
          document.getElementById("check-no-repeat-personal").checked =
            !!s.noRepeatPersonal;
          document.getElementById("check-auto-reduce").checked =
            !!s.autoReduceWeight;
        },
        updateBubble(range, bubble) {
          const val = range.value;
          const min = range.min ? parseInt(range.min) : 0;
          const max = range.max ? parseInt(range.max) : 100;
          const newVal = Number(((val - min) * 100) / (max - min));

          bubble.innerText = val;
          // è¨ˆç®—ä½ç½®ï¼š(ç™¾åˆ†æ¯” * (å®¹å™¨å¯¬åº¦ - æ»‘å¡Šå¯¬åº¦)) + åŠå€‹æ»‘å¡Šå¯¬åº¦
          // é€™è£¡å‡è¨­æ»‘å¡Šå¯¬åº¦ç´„ç‚º 20px (CSSä¸­è¨­å®š)
          bubble.style.left = `calc(${newVal}% + (${10 - newVal * 0.2}px))`;
        },
        showResult(type, content, player, level, isReset) {
          document.getElementById("player-name-slot").innerText = player;
          const box = document.getElementById("display-result");

          // Reset classes and apply level class
          box.className = "result-box";
          if (level) {
            box.classList.add("level-" + level.toLowerCase());
          }

          let color = "#ccc";
          let grad = "rgba(0,0,0,0.6)";

          if (type === "truth") {
            color = "#4CAF50";
            grad =
              "linear-gradient(135deg, rgba(21, 101, 192, 0.5) 0%, rgba(0, 0, 0, 0.8) 100%)";
          }
          if (type === "dare") {
            color = "#FF5722";
            grad =
              "linear-gradient(135deg, rgba(198, 40, 40, 0.5) 0%, rgba(0, 0, 0, 0.8) 100%)";
          }
          if (type === "pass") {
            color = "#D4AF37";
            grad =
              "linear-gradient(135deg, rgba(212, 175, 55, 0.4) 0%, rgba(0, 0, 0, 0.8) 100%)";
          }

          document.querySelector(".game-info").style.background = grad;
          box.innerHTML = `<span style="color:${color}">[${type.toUpperCase()}]</span> ${content}`;

          if (isReset) {
            box.innerHTML += `<span class="reset-badge">â™»ï¸ é‡æ–°æ´—ç‰Œ</span>`;
          }

          EffectModule.triggerConfetti();
          EffectModule.flash(type);
        },
        showRoomQR() {
          if (NetworkModule.roomId && NetworkModule.roomId !== "LOCAL") {
            const url = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${NetworkModule.roomId}`;
            document.getElementById("qr-image").src = url;
            document
              .getElementById("qr-display-overlay")
              .classList.remove("hidden");
          }
        },
        showReaction(emoji) {
          const layer = document.getElementById("danmaku-layer");
          const el = document.createElement("div");
          el.className = "danmaku-item";
          el.innerText = emoji;

          // Random position
          const left = Math.random() * 80 + 10; // 10% to 90%
          el.style.left = left + "%";

          // Random size variation
          const size = 1.5 + Math.random();
          el.style.fontSize = size + "rem";

          // Random duration
          const duration = 3 + Math.random() * 2;
          el.style.animationDuration = duration + "s";

          layer.appendChild(el);
          setTimeout(() => {
            el.remove();
          }, duration * 1000);
        },
        toggleReactions() {
          document.getElementById("reaction-menu").classList.toggle("hidden");
        },
      };

      const EffectModule = {
        triggerConfetti() {
          const colors = ["#d4af37", "#f4df87", "#ffffff"];
          confetti({
            particleCount: 100,
            spread: 70,
            origin: { y: 0.6 },
            colors: colors,
          });
        },
        flash(type) {
          const overlay = document.getElementById("flash-overlay");
          // Reset animation
          overlay.className = "";
          void overlay.offsetWidth; // Trigger reflow

          if (type === "truth") {
            overlay.classList.add("flash-truth");
            if (navigator.vibrate) navigator.vibrate(200);
          } else if (type === "dare") {
            overlay.classList.add("flash-dare");
            if (navigator.vibrate) navigator.vibrate(200);
          } else if (type === "pass") {
            overlay.classList.add("flash-pass");
            if (navigator.vibrate) navigator.vibrate(100);
          }
        },
      };

      const AudioModule = {
        bgm: null,
        spin: null,
        win: null,
        alarm: null,
        init() {
          this.bgm = document.getElementById("bgm");
          this.spin = document.getElementById("sfx-spin");
          this.win = document.getElementById("sfx-win");
          this.alarm = document.getElementById("sfx-alarm");
        },
        play(k) {
          if (this[k]) this[k].play().catch(() => {});
        },
        stop(k) {
          if (this[k]) {
            this[k].pause();
            this[k].currentTime = 0;
          }
        },
      };

      const TimerModule = {
        mode: "countdown",
        time: 0,
        initialTime: 0,
        interval: null,
        isRunning: false,
        init() {
          this.update();
        },
        switchMode(newMode) {
          this.reset();
          this.mode = newMode;
          const presets = document.getElementById("timer-presets-container");
          if (this.mode === "stopwatch") {
            this.time = 0;
            this.initialTime = 0;
            presets.style.display = "none";
          } else {
            this.time = 0;
            this.initialTime = 0;
            presets.style.display = "flex";
          }
          this.update();
        },
        toggle() {
          if (this.isRunning) this.pause();
          else this.start();
        },
        start() {
          if (this.isRunning) return;
          this.isRunning = true;
          document.getElementById("timer-icon-play").innerText = "pause";
          this.interval = setInterval(() => {
            if (this.mode === "countdown") {
              this.time--;
              if (this.time <= 0) this.finish();
            } else this.time++;
            this.update();
          }, 1000);
        },
        pause() {
          this.isRunning = false;
          clearInterval(this.interval);
          document.getElementById("timer-icon-play").innerText = "play_arrow";
        },
        reset() {
          this.pause();
          this.time = this.initialTime;
          // Smart Reset: è‹¥ç•¶å‰å·²æ˜¯è¨­å®šæ™‚é–“ï¼Œå†æ¬¡é»æ“Šå‰‡æ­¸é›¶(é è¨­å€¼)ï¼›å¦å‰‡é‡ç½®å›è¨­å®šæ™‚é–“
          if (this.time === this.initialTime && this.initialTime > 0) {
            this.time = 0;
            this.initialTime = 0;
          } else {
            this.time = this.initialTime;
          }
          document
            .getElementById("timer-display")
            .classList.remove("timer-blink");
          document.body.classList.remove("shake-screen");
          this.update();
        },
        finish() {
          this.pause();
          document.getElementById("timer-display").classList.add("timer-blink");
          document.body.classList.add("shake-screen");
          if (navigator.vibrate) navigator.vibrate([500, 200, 500, 200, 500]);
          AudioModule.play("alarm");
          // Stop shaking after 5 seconds
          setTimeout(() => {
            document.body.classList.remove("shake-screen");
          }, 5000);
        },
        addTime(s) {
          if (this.mode === "countdown") {
            this.time += s;
            this.initialTime = this.time;
            this.update();
          }
        },
        update() {
          const m = Math.floor(this.time / 60)
            .toString()
            .padStart(2, "0");
          const s = (this.time % 60).toString().padStart(2, "0");
          document.getElementById("timer-display").innerText = `${m}:${s}`;
        },
      };

      const ScannerModule = {
        scanner: null,
        start() {
          document.getElementById("scanner-overlay").classList.remove("hidden");
          setTimeout(() => {
            if (!this.scanner) {
              this.scanner = new Html5Qrcode("reader");
            }
            this.scanner
              .start(
                { facingMode: "environment" },
                { fps: 10, qrbox: { width: 250, height: 250 } },
                (decodedText) => {
                  this.stop();
                  document.getElementById("room-code-input").value =
                    decodedText;
                  if (/^\d{6}$/.test(decodedText)) NetworkModule.joinRoom();
                },
                (errorMessage) => {}
              )
              .catch((err) => {
                alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ");
                this.stop();
              });
          }, 100);
        },
        stop() {
          document.getElementById("scanner-overlay").classList.add("hidden");
          if (this.scanner)
            this.scanner
              .stop()
              .then(() => this.scanner.clear())
              .catch(() => {});
        },
      };

      window.onload = () => {
        DataModule.init();
        UIModule.init();
        TimerModule.init();
      };
    </script>
  </body>
</html>
